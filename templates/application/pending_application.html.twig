{% extends 'baseBack.html.twig' %}

{% block title %}Company Applications{% endblock %}

{% block body %}
    <div class="container mt-4" id="main-container">
        <h1 class="mb-4">Job Applications for Company</h1>
        
        {% if company_id is defined and company_id %}
            {% if applications|length == 0 %}
                <div class="alert alert-info">No applications found for this company.</div>
            {% else %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Applicant ID</th>
                                <th>Job ID</th>
                                <th>Applied Date</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for application in applications %}
                                <tr>
                                    <td>{{ application.userId }}</td>
                                    <td>{{ application.jobId }}</td>
                                    <td>{{ application.appliedDate|date('Y-m-d') }}</td>
                                    <td>
                                        <form method="post" action="{{ path('app_update_application', {'id': application.id}) }}">
                                            <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                                <option value="Pending" {{ application.status == 'Pending' ? 'selected' : '' }}>Pending</option>
                                                <option value="Accepted" {{ application.status == 'Accepted' ? 'selected' : '' }}>Accepted</option>
                                                <option value="Rejected" {{ application.status == 'Rejected' ? 'selected' : '' }}>Rejected</option>
                                            </select>
                                        </form>
                                    </td>
                                    <td>
                                        <a href="{{ path('app_job_show', {'id': application.jobId}) }}" 
                                           class="btn btn-sm btn-outline-info">View Job</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-warning mt-4" id="no-company-alert" style="display:none;">
                No company selected. Please set your company ID in local storage.<br>
                <code>localStorage.setItem('company_id', 'YOUR_COMPANY_ID')</code>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function getQueryParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }
        
            const urlCompanyId = getQueryParam('company_id');
        
            if (!urlCompanyId) {
                const storedCompanyId = localStorage.getItem('company_id');
                if (storedCompanyId) {
                    // Redirect to same route with ?company_id=storedCompanyId
                    const baseUrl = window.location.pathname;
                    window.location.href = `${baseUrl}?company_id=${encodeURIComponent(storedCompanyId)}`;
                } else {
                    // Show alert for missing company_id
                    document.getElementById('no-company-alert').style.display = 'block';
                }
            }
        });
        </script>
{% endblock %}